<div class="alquileres-container">
  <div class="header">
    <h2>Gestión de Alquileres</h2>
    <div class="header-actions">
      <button *ngIf="canEdit()" 
              class="btn-primary" 
              routerLink="/dashboard/alquileres/nuevo">
        <span class="material-icons">add</span>
        Nuevo Alquiler
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-card">
    <h3>Filtrar Alquileres</h3>
    <div class="filters-row">
      <div class="form-group">
        <label>Estado</label>
        <select [(ngModel)]="filtros.estado" class="form-control">
          <option value="">Todos los estados</option>
          <option *ngFor="let estado of estadosAlquiler" [value]="estado">
            {{estado}}
          </option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Cliente</label>
        <select [(ngModel)]="filtros.clienteId" class="form-control">
          <option [value]="null">Todos los clientes</option>
          <option *ngFor="let cliente of clientes" [value]="cliente.id">
            {{cliente.nombre}} {{cliente.apellido}}
          </option>
        </select>
      </div>
      
      <div class="filter-buttons">
        <button class="btn-primary" (click)="buscarAlquileres()">
          <span class="material-icons">search</span>
          Buscar
        </button>
        <button class="btn-gray" (click)="limpiarFiltros()">
          <span class="material-icons">clear</span>
          Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de alquileres -->
  <div class="table-container">
    <table mat-table [dataSource]="dataSource" class="alquileres-table">
      
      <!-- ID Column -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let alquiler">{{alquiler.id}}</td>
      </ng-container>
      
      <!-- Cliente Column -->
      <ng-container matColumnDef="cliente">
        <th mat-header-cell *matHeaderCellDef>Cliente</th>
        <td mat-cell *matCellDef="let alquiler">
         {{alquiler.cliente?.nombreCompleto || 'N/A' }}
        </td>
      </ng-container>
      
      <!-- Vehículo Column -->
      <ng-container matColumnDef="vehiculo">
          <th mat-header-cell *matHeaderCellDef>Vehículo</th>
          <td mat-cell *matCellDef="let alquiler">  
          <span *ngIf="alquiler.vehiculo">
              {{ alquiler.vehiculo.marca }} {{ alquiler.vehiculo.modelo }}
          </span>
            <span *ngIf="alquiler.car">
                {{ alquiler.car.marca }} {{ alquiler.car.modelo }}
              </span>
          <span *ngIf="!alquiler.vehiculo" class="text-muted">N/A</span>
        </td>
        </ng-container>
      
      <!-- Fecha Inicio Column -->
      <ng-container matColumnDef="fechaInicio">
        <th mat-header-cell *matHeaderCellDef>Fecha Inicio</th>
        <td mat-cell *matCellDef="let alquiler">
          {{alquiler.fechaInicio | date:'dd/MM/yyyy HH:mm'}}
        </td>
      </ng-container>
      
      <!-- Fecha Fin Column -->
      <ng-container matColumnDef="fechaFin">
        <th mat-header-cell *matHeaderCellDef>Fecha Fin</th>
        <td mat-cell *matCellDef="let alquiler">
          {{alquiler.fechaFinEstimada | date:'dd/MM/yyyy HH:mm'}}
        </td>
      </ng-container>
      
      <!-- Estado Column -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let alquiler">
          <span class="badge" [ngClass]="getEstadoBadgeClass(alquiler.estado)">
            {{alquiler.estado}}
          </span>
        </td>
      </ng-container>
      
      <!-- Precio Total Column -->
      <ng-container matColumnDef="precioTotal">
        <th mat-header-cell *matHeaderCellDef>Precio Total</th>
        <td mat-cell *matCellDef="let alquiler">
          {{alquiler.precioTotal | currency:'USD':'symbol':'1.2-2'}}
        </td>
      </ng-container>
      
      <!-- Acciones Column -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let alquiler">
          <div class="actions">
            <button class="btn-icon" 
                    (click)="verDetalles(alquiler)"
                    title="Ver detalles">
              <span class="material-icons">visibility</span>
            </button>
            
            <button *ngIf="canEdit() && alquiler.estado === 'ACTIVO'" 
                    class="btn-icon btn-success"
                    (click)="abrirModalDevolucion(alquiler)"
                    title="Registrar devolución">
              <span class="material-icons">check_circle</span>
            </button>
            
            <button *ngIf="canEdit() && alquiler.estado === 'ACTIVO'" 
                    class="btn-icon btn-warning"
                    (click)="cancelarAlquiler(alquiler.id)"
                    title="Cancelar alquiler">
              <span class="material-icons">cancel</span>
            </button>
            
            <button *ngIf="canDelete()" 
                    class="btn-icon btn-danger"
                    (click)="eliminarAlquiler(alquiler.id)"
                    title="Eliminar">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </td>
      </ng-container>
      
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
    
    <div *ngIf="isLoading" class="loading">
      <div class="spinner"></div>
      <span>Cargando alquileres...</span>
    </div>
    
    <div *ngIf="alquileres.length === 0 && !isLoading" class="no-data">
      No se encontraron alquileres
    </div>
  </div>

  <!-- Paginación -->
  <mat-paginator [length]="totalElements"
                 [pageSize]="pageSize"
                 [pageSizeOptions]="[5, 10, 20]"
                 aria-label="Select page">
  </mat-paginator>
</div>

<!-- Modal de Devolución -->
<div *ngIf="mostrarModalDevolucion" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Registrar Devolución</h3>
      <button class="btn-close" (click)="cerrarModalDevolucion()">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <div class="modal-body">
      <div *ngIf="alquilerSeleccionado" class="alquiler-info">
        <p><strong>Cliente:</strong> {{alquilerSeleccionado.cliente?.nombreCompleto || 'N/A'}}</p>
<p><strong>Vehículo:</strong> {{alquilerSeleccionado.vehiculo?.marca}} {{alquilerSeleccionado.vehiculo?.modelo}}</p>
        <p><strong>Fecha Inicio:</strong> {{alquilerSeleccionado.fechaInicio | date:'dd/MM/yyyy HH:mm'}}</p>
        <p><strong>Kilometraje Inicial:</strong> {{alquilerSeleccionado.kilometrajeInicio}} km</p>
      </div>
      
      <form (ngSubmit)="registrarDevolucion()">
        <div class="form-group">
          <label>Fecha de Devolución *</label>
          <input type="datetime-local" 
                 [(ngModel)]="datosDevolucion.fechaDevolucion" 
                 name="fechaDevolucion"
                 class="form-control"
                 required>
        </div>
        
        <div class="form-group">
          <label>Kilometraje Final *</label>
          <input type="number" 
                 [(ngModel)]="datosDevolucion.kilometrajeFin" 
                 name="kilometrajeFin"
                 class="form-control"
                 min="0"
                 required>
        </div>
        
        <div class="form-group">
          <label>Observaciones</label>
          <textarea [(ngModel)]="datosDevolucion.observaciones" 
                    name="observaciones"
                    class="form-control"
                    rows="3"></textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" 
                  class="btn-secondary" 
                  (click)="cerrarModalDevolucion()">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn-primary"
                  [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-small"></span>
            {{isLoading ? 'Procesando...' : 'Registrar Devolución'}}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Detalles -->
<div *ngIf="mostrarModalDetalles" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Detalles del Alquiler</h3>
      <button class="btn-close" (click)="cerrarModalDetalles()">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <div *ngIf="alquilerDetalles" class="modal-body">
      <div class="detail-section">
        <h4>Información del Alquiler</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <strong>ID:</strong> {{alquilerDetalles.id}}
          </div>
          <div class="detail-item">
            <strong>Estado:</strong>
            <span class="badge" [ngClass]="getEstadoBadgeClass(alquilerDetalles.estado)">
              {{alquilerDetalles.estado}}
            </span>
          </div>
          <div class="detail-item">
            <strong>Fecha Inicio:</strong> {{alquilerDetalles.fechaInicio | date:'dd/MM/yyyy HH:mm'}}
          </div>
          <div class="detail-item">
            <strong>Fecha Fin Estimada:</strong> {{alquilerDetalles.fechaFinEstimada | date:'dd/MM/yyyy HH:mm'}}
          </div>
          <div *ngIf="alquilerDetalles.fechaDevolucion" class="detail-item">
            <strong>Fecha Devolución:</strong> {{alquilerDetalles.fechaDevolucion | date:'dd/MM/yyyy HH:mm'}}
          </div>
          <div class="detail-item">
            <strong>Precio Total:</strong> {{alquilerDetalles.precioTotal | currency:'USD':'symbol':'1.2-2'}}
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>Información del Vehículo</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <strong>Kilometraje Inicial:</strong> {{alquilerDetalles.kilometrajeInicio}} km
          </div>
          <div *ngIf="alquilerDetalles.kilometrajeFin" class="detail-item">
            <strong>Kilometraje Final:</strong> {{alquilerDetalles.kilometrajeFin}} km
          </div>
          <div *ngIf="alquilerDetalles.observaciones" class="detail-item full-width">
            <strong>Observaciones:</strong> {{alquilerDetalles.observaciones}}
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" 
                class="btn-secondary" 
                (click)="cerrarModalDetalles()">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>